pipeline {
  agent any

  environment {
    ANDROID_HOME    = "/opt/android-sdk"
    PATH            = "$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$PATH"
    GRADLE_OPTS     = "-Dorg.gradle.jvmargs=-Xmx4g"
    HOME            = "/var/jenkins_home"
    ADB_VENDOR_KEYS = "$HOME/.android/adbkey"
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Setup local.properties') {
      steps {
        sh 'echo "sdk.dir=$ANDROID_HOME" > local.properties'
      }
    }

    stage('Start Emulator') {
      steps {
        sh '''
          echo "üõë Restarting ADB server‚Ä¶"
          adb kill-server && adb start-server

          echo "üöÄ Starting emulator under Xvfb‚Ä¶"
          mkdir -p $HOME/.android
          rm -f $HOME/.android/adbkey*
          touch $HOME/.android/adbkey $HOME/.android/adbkey.pub

          # 1) Launch headless emulator in background
          nohup xvfb-run --auto-servernum --server-args="-screen 0 1280x1024x24" \
            $ANDROID_HOME/emulator/emulator -avd jenkins_emulator \
            -no-audio -no-snapshot -wipe-data \
            -gpu swiftshader_indirect -accel off -no-boot-anim -no-window \
            > emulator.log 2>&1 &

          # 2) Wait for ADB to see it
          echo "üîç Waiting for emulator to register‚Ä¶"
          adb wait-for-device

          # 3) Wait for full boot (max ~180s)
          echo "‚è≥ Waiting for boot completion (max 180s)‚Ä¶"
          for i in {1..36}; do
            if adb shell getprop sys.boot_completed | grep -q 1; then
              echo "‚úÖ Emulator booted"
              break
            fi
            sleep 5
          done

          # 4) Disable animations for Espresso
          echo "üö´ Disabling animations for Espresso‚Ä¶"
          adb shell cmd settings put global window_animation_scale 0
          adb shell cmd settings put global transition_animation_scale 0
          adb shell cmd settings put global animator_duration_scale 0

          # 5) Wake & unlock
          echo "üîì Unlocking screen‚Ä¶"
          adb shell input keyevent 224       # WAKEUP
          adb shell wm dismiss-keyguard      # dismiss keyguard
          adb shell input keyevent 82        # MENU/HOME
          sleep 2

          # 6) Verify our app can take focus
          echo "üîç Verifying focus‚Ä¶"
          adb shell dumpsys window windows | grep -E "mCurrentFocus|has-window-focus=true"
        '''
      }
    }

    stage('Build APK') {
      steps {
        sh './gradlew assembleDebug'
      }
    }

    stage('Run Instrumented UI Tests') {
      steps {
        sh '''
          export ANDROID_SERIAL=emulator-5554
          echo "üß™ Running Espresso/UI Tests‚Ä¶"
          ./gradlew connectedDebugAndroidTest
        '''
      }
    }

    stage('Archive Test Results') {
      steps {
        sh 'echo "üìÇ Searching for test XML files‚Ä¶"; find . -name "*.xml" || true'
        junit '**/build/outputs/**/connected/**/*.xml'
      }
    }
  }

  post {
    always {
      echo "üõë Stopping emulator"
      sh '''
        adb -s emulator-5554 emu kill || true
        pkill -f "emulator.*jenkins_emulator" || true
        pkill -f "qemu-system-x86_64" || true
      '''
    }
    success {
      echo "‚úÖ Build and UI tests successful"
    }
    failure {
      echo "‚ùå Build or tests failed"
    }
  }
}
